<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.api.mapper.AutoCaseMapper">

    <insert id="insertAutoCase">
        <if test="isTemplate!=null and isTemplate=='false'">
            INSERT INTO auto_case_scenario (enable, "isSanity", component, "templateName", "issueKey", summary,
            "testData", variables,
            scenario, label, "componentLike", profile,"isTemplate", script, endpoint, method, "endpointLike",update_at)
            SELECT ${enable}, ${isSanity}, #{component}, '', '${issueKey}',
            #{summary},#{testData}::jsonb,#{variables}::jsonb,
            #{scenario}, #{label},
            #{componentLike}::jsonb,
            #{profile}::jsonb,
            false,
            #{script}::jsonb,
            #{endpoint},
            #{method},
            #{endpointLike}::jsonb,
            now() AT TIME ZONE 'Asia/Shanghai'
            FROM auto_case_scenario
            WHERE NOT EXISTS (
            SELECT 1 FROM auto_case_scenario
            WHERE component = #{component}
            AND scenario = #{scenario}
            AND summary = #{summary}
            AND "issueKey" = #{issueKey}
            AND label = #{label}
            ) limit 1;
        </if>

        <if test="isTemplate!=null and isTemplate=='true'">
            update auto_case_template set script = #{script}::jsonb, variables = #{variables}::jsonb where
            component = #{component} and "templateName" = #{templateName};
            INSERT INTO auto_case_scenario (enable, "isSanity", component, "templateName", "issueKey",
            summary, "testData", variables,
            scenario, label, "componentLike", profile,"isTemplate", script, endpoint, method,
            "endpointLike", update_at)
            SELECT ${enable}, ${isSanity}, #{component}, #{templateName}, '${issueKey}',
            #{summary},#{testData}::jsonb,#{variables}::jsonb,
            #{scenario}, #{label},
            #{componentLike}::jsonb,
            #{profile}::jsonb,
            true,
            '[]'::jsonb,
            #{endpoint},
            #{method},
            #{endpointLike}::jsonb,
            now() AT TIME ZONE 'Asia/Shanghai'
            FROM auto_case_scenario
            WHERE NOT EXISTS (
            SELECT 1 FROM auto_case_scenario
            WHERE component = #{component}
            AND scenario = #{scenario}
            AND summary = #{summary}
            AND "issueKey" = #{issueKey}
            AND label = #{label}
            ) limit 1;
        </if>
    </insert>

</mapper>